<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Вход</title>
<style>
:root{--bg:#f6f8fb;--card:#fff;--line:#e5e7eb;--muted:#6b7280;--brand:#facc15;--ok:#10b981;--err:#ef4444}
body{margin:0;background:var(--bg);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:900px;margin:8vh auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:20px}
h1{font-size:18px;margin:0 0 12px}
label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
input{width:100%;box-sizing:border-box;padding:12px;border:1px solid var(--line);border-radius:12px;font:inherit}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
.btn.brand{background:var(--brand);border:none}
.btn.ok{background:var(--ok);border:none;color:#fff}
.btn:disabled{opacity:.6;cursor:not-allowed}
.row{display:flex;gap:8px;align-items:center;margin-top:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.small{font-size:12px;color:var(--muted)}
.err{color:var(--err);margin-top:8px}
.hidden{display:none}
.cardx{border:1px solid var(--line);border-radius:14px;padding:16px;background:#fff}
.cardx h3{margin:0 0 8px;font-size:16px}
</style>
</head>
<body>
<div class="wrap">
  <div id="gate" class="card">
    <h1>Вход в портал</h1>
    <label>Пароль</label>
    <input id="gatepwd" type="password" placeholder="Введите общий пароль">
    <div class="row">
      <button id="go" class="btn brand">Далее ➜</button>
    </div>
    <div id="gmsg" class="err hidden"></div>
    <div class="small">После входа появятся карточки администратора и пользователей.</div>
  </div>

  <div id="desk" class="card hidden">
    <div class="row">
      <h1>Панель</h1>
      <button id="logout" class="btn">Выйти</button>
    </div>
    <div id="cards" class="grid"></div>
    <div id="amsg" class="err hidden"></div>
  </div>

  <div id="admin" class="card hidden">
    <div class="row">
      <h1>Администратор</h1>
      <button id="aback" class="btn">← Назад</button>
    </div>
    <div class="small">Измените данные и нажмите «Сохранить». Пароли задаются кнопкой «Пароль…»</div>
    <div id="atable"></div>
  </div>
</div>

<script>
const $ = s=>document.querySelector(s);
const Gate = {wrap:$('#gate'), pwd:$('#gatepwd'), go:$('#go'), msg:$('#gmsg')};
const Desk = {wrap:$('#desk'), cards:$('#cards'), msg:$('#amsg'), logout:$('#logout')};
const Adm  = {wrap:$('#admin'), back:$('#aback'), table:$('#atable')};

function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function err(el, t){ if(t){ el.textContent=t; el.classList.remove('hidden'); } else { el.textContent=''; el.classList.add('hidden'); } }

Gate.go.addEventListener('click', ()=>{
  err(Gate.msg,''); Gate.go.disabled=true;
  google.script.run.withSuccessHandler(res=>{
    Gate.go.disabled=false;
    if(!res.ok){ err(Gate.msg,res.msg||'Ошибка'); return; }
    window.__users = res.users || [];
    renderCards();
    hide(Gate.wrap); show(Desk.wrap);
  }).api_gateLogin(Gate.pwd.value);
});

Desk.logout.addEventListener('click', ()=>{
  hide(Desk.wrap); hide(Adm.wrap);
  show(Gate.wrap); Gate.pwd.value=''; Gate.pwd.focus();
});

Adm.back.addEventListener('click', ()=>{
  hide(Adm.wrap); show(Desk.wrap);
});

function renderCards(){
  const box = Desk.cards; box.innerHTML='';
  (window.__users||[]).forEach(u=>{
    const el = document.createElement('div'); el.className='cardx';
    const ro = u.role==='admin'?'Администратор': u.role==='editor'?'Редактор':'Просмотр';
    el.innerHTML = `
      <h3>${u.name}</h3>
      <div class="small">Роль: ${ro}</div>
      <div class="row" style="margin-top:10px">
        <input type="password" placeholder="${u.role==='admin'?'Пароль администратора':'Пароль пользователя'}" ${u.protected?'':'disabled'} data-pw="${u.name}">
        <button class="btn ok" data-open="${u.name}">${u.role==='admin'?'Открыть панель':'Открыть'}</button>
      </div>
      ${u.protected?'':'<div class="small">Пароль не требуется</div>'}
    `;
    box.appendChild(el);
  });

  box.querySelectorAll('[data-open]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const name = e.currentTarget.dataset.open;
      const inp  = box.querySelector(`input[data-pw="${name}"]`);
      const pwd  = inp ? inp.value : '';
      err(Desk.msg,'');
      google.script.run.withSuccessHandler(r=>{
        if(!r || !r.ok){ err(Desk.msg, r&&r.msg? r.msg : 'Ошибка'); return; }
        if (r.admin){
          buildAdmin(r.users);
          hide(Desk.wrap); show(Adm.wrap);
        }else if(r.url){
          window.open(r.url,'_blank','noopener');
        }
      }).api_userOpen(name, pwd);
    });
  });
}

function buildAdmin(users){
  const box = Adm.table; box.innerHTML='';
  const makeRow = (u)=> `
    <tr>
      <td><input data-f="name" value="${u.name||''}" style="width:160px"></td>
      <td>
        <select data-f="role">
          <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
          <option value="editor" ${u.role==='editor'?'selected':''}>editor</option>
          <option value="viewer" ${u.role==='viewer'?'selected':''}>viewer</option>
        </select>
      </td>
      <td><input data-f="doc_id" value="${u.doc_id||''}" style="width:280px"></td>
      <td><input data-f="sheet"  value="${u.sheet||''}"  style="width:160px"></td>
      <td style="text-align:center"><input type="checkbox" data-f="enabled" ${u.enabled?'checked':''}></td>
      <td style="text-align:center"><input type="checkbox" data-f="can_edit" ${u.can_edit?'checked':''}></td>
      <td>
        <button class="btn" data-act="save">Сохранить</button>
        <button class="btn" data-act="pwd">Пароль…</button>
      </td>
    </tr>`;
  box.innerHTML = `
    <table style="width:100%;border-collapse:collapse">
      <thead>
        <tr style="text-align:left;border-bottom:1px solid var(--line)">
          <th>Имя</th><th>Роль</th><th>doc_id</th><th>sheet</th>
          <th>Вкл</th><th>Редакт.</th><th>Действия</th>
        </tr>
      </thead>
      <tbody>${users.map(makeRow).join('')}</tbody>
    </table>
    <div class="row" style="margin-top:10px">
      <button id="add" class="btn">+ Добавить</button>
    </div>
  `;

  box.querySelector('#add').addEventListener('click', ()=>{
    const tbody = box.querySelector('tbody');
    const blank = {name:'Новый', role:'viewer', enabled:true, can_edit:false, doc_id:'', sheet:''};
    tbody.insertAdjacentHTML('beforeend', makeRow(blank));
    bindRow(tbody.lastElementChild);
  });

  box.querySelectorAll('tbody tr').forEach(bindRow);

  function bindRow(tr){
    const q = sel => tr.querySelector(sel);
    const read = ()=>{
      return {
        currentName: q('input[data-f="name"]').getAttribute('value'),
        name:  q('input[data-f="name"]').value.trim(),
        role:  q('select[data-f="role"]').value,
        doc_id:q('input[data-f="doc_id"]').value.trim(),
        sheet: q('input[data-f="sheet"]').value.trim(),
        enabled:q('input[data-f="enabled"]').checked,
        can_edit:q('input[data-f="can_edit"]').checked
      };
    };
    tr.querySelectorAll('[data-act="save"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const payload = read();
        google.script.run.withSuccessHandler(r=>{
          if(!r || !r.ok){ alert(r&&r.msg? r.msg:'Ошибка'); return; }
          alert('Сохранено');
          tr.querySelector('input[data-f="name"]').setAttribute('value', payload.name);
        }).api_adminUpsert(payload);
      });
    });
    tr.querySelectorAll('[data-act="pwd"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const name = q('input[data-f="name"]').value.trim();
        const np = prompt('Новый пароль для: '+name);
        if(!np) return;
        google.script.run.withSuccessHandler(r=>{
          if(!r || !r.ok){ alert(r&&r.msg? r.msg:'Ошибка'); return; }
          alert('Пароль обновлён (salt+hash записаны в таблицу).');
        }).api_adminResetPassword(name, np);
      });
    });
  }
}
</script>
</body>
</html>
